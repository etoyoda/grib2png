# gribslim プログラム
GRIB2 のファイルの一部を抽出するプログラム
# 書式
gribslim [-a|-fFILTER][-q|-oFILENAME] FILES ...
# 説明
gribslim は入力 FILES を読み取り、一部を抽出してひとつの GRIB2 をファイル distilled.bin (または -o オプションで指定したファイル名) に書き出します。
GRIB ファイルの連結や内容確認にも使えます。
# オプション
## -oFILENAME
出力ファイル名を指定します（デフォルトはdistilled.bin）。
## -fFILTER
FILTER 文字列で指定される一部だけを出力します（文法は後述）。
## -a
入力の全部を出力します。
オプション -a も -f も指定されない場合は歴史的経緯互換モードです（後述）。
## -q
出力をしません。
# 用例
たぶん難しいので用例を先に書きます。

いちばんありがちなのは、たとえば降水量だけを抽出することでしょう。
```
$ gribslim -fp[RAIN]= -ooutput.bin input.bin
```
オプション `-f` に続くのは、 `p` がパラメタ番号、`[RAIN]` が降水量のパラメタ番号、 `=` が二項演算子です。二項演算子を後置するのが逆ポーランド記法です。

下のリファレンスに載っていないパラメタの場合は数値で指定できます。
さっきの RAIN は分野 0 カテゴリ 1 パラメタ 8 ですので、それぞれ十六進数2桁で
```
$ gribslim -fpx000108= -ooutput.bin input.bin
```
とやっても同じ結果になります。

複数の条件を指定する場合は、
論理演算子 `&` (and), `|` (or), `!` (not) が後置されます。
たとえば気温 `[T]` の 100 hPa より上（低圧）の予
報時間 24 時間以下を選択するならば:
```
$ gribslim -f'p[T]=v10000<g1440>!&&' -ooutput.bin input.bin
```
となります。
ここで気圧はパスカル単位なので 100 hPa が `10000` となり、
時間は分単位なので 24 時間が 1440 分と指定します。
演算子にみえる `>!` は g is greater than 1440 を計算したあと論理否定 not しますので、結局 less than or equals になります。
また、予報時間 `f` は降水など時間積算量では
積算開始時刻（つまりGSMなどではゼロ）となるので、
予報時間と積算時間の和 `g` を常用するとよいと思います。
なお、全体をシングルクォート `'...'` で囲っているのは
シェルがメタキャラクタ (`<`, `>`, `&` など) を処理せず
そのまま gribslim に渡すためですが、
よく使いそうな演算子は英大文字の代替表現を用意してありますので
```
$ gribslim -fp[T]Ev85000Lg1440GNKK -ooutput.bin input.bin
```
としても同じ結果になります。読みやすいかどうかはともかくとして。

ついでに、四則演算でよく使いそうな乗算 `*` と剰余 `%` が用意されています。
たとえば24時間間隔でジオポテンシャル `[Z]` を抜き出すならば
```
$ gribslim -f'p[Z]=g1440%0=&' -ooutput.bin input.bin
```
とします。また分単位がわかりにくければ `1440` と同値な
時間単位の表現 `24,60*` というのが使えます。
ここでコンマは何もしない区切りです。

# フィルタ言語
フィルタ言語は原則1語1文字の逆ポーランド記法です。データ型は倍精度浮動小数点数しかありません。
入力GRIBのデータ節（第7節）がデコードされるたびに毎回フィルタ言語が解釈され、終わった後のスタックトップが真（非零）になったものが出力されます。
## 置数
以下のコマンド群はいずれも、スタックになんらかの数値をプッシュして、以前のスタックトップ以下は2番目以下に繰り下げられます。
### d
積算時間（duration）を分単位であらわした数値をスタックトップに置きます。
### f
予報時間（forecast time）を分単位であらわした数値をスタックトップに置きます。
### g
予報時間と積算時間の合計を、分単位であらわした数値をスタックトップに置きます。
### p
パラメタを特定する整数値（(discipline*256+category)*256+parameter）をスタックトップに置きます。
### v
鉛直面の位置（気圧ならば Pa 単位）をスタックトップに置きます。
### m
アンサンブル予報について摂動番号をスタックトップに置きます。
アンサンブルではない場合または（日本では使われない）低解像度コントロールランの場合には -0.0 をスタックトップに置きます。
### x_十六進数_
x があると、引き続く16進数字列のあらわす整数値がスタックトップに置かれます。
### 浮動小数点値
0～9 またはマイナスで始まる浮動小数点数字列（strtod(3)で認識されるもの）があればその値がスタックトップに置かれます。
### [名前]
パラメタ名や鉛直面名をあらわす数字を覚えないで済ますための代替表現です。
いまのところ認識されるパラメタ名は
T, papT, dT, RH, RR1H, RAIN, WD, WINDS, U, V, PSI, CHI, VVPa, rVOR, rDIV,
Pres, Pmsl, Z, RSDB, CLA, CLL, CLM, CLH であり、
それぞれの意味は NuSDaS ドキュメントを参照してください。
鉛直面名は SURF,MSL,2m,10m が認識されます。
認識できない名前は NaN がスタックトップに置かれます。
### :
スタックトップと同じ値を置きます。
## 演算子
### & または K
論理積 (and) 演算子です。英字 `K` はポーランド記法にあわせています。
### | または A
論理和 (or) 演算子です。英字 `A` はポーランド記法にあわせています。
### = または E
等号比較演算子 (equals) です。英字 `E` はポーランド記法にあわせています。
### < または L
比較演算子（less than）です。等号つき比較 less than or equals は `>!` または `GN` としてください。
### > または G
比較演算子（greater than）です。等号つき比較 greater than or equals は `<!` または `LN` としてください。
### % または R
剰余（remainder）を計算します。
C の remainder(3) 関数を使っているので、負の値を食わせたばあいにも正の値が返ります（Fortran の MODULO 関数と同様）。
システムプログラミングではその方がいいと思うんだ。
### * または M
乗法（multiplication）演算子です。
### ! または N
論理否定（not）演算子です。英字 `N` はポーランド記法にあわせています。
## その他
### ,
コンマ文字は無視されます。
# 歴史的経緯互換モード
歴史的経緯から、 `-a` も `-f` も指定しない場合は
`-fp[VVPa]=v70000=v30000=|&,p[rDIV]=v85000=v25000=|&,p[rVOR]=v50000=&,p[U]=p[V]=p[T]=p[RH]=p[Z]=||||,|||,g361<&,p[Z]=v50000=v92500=|&,p[U]=p[V]=p[T]=||v50000=v92500=|&,p[RH]=v70000=v92500=|&,p[RAIN]=p[Pmsl]=|,|||,g720%0=g360=|&,|`
を指定したのと同じことになります。
# バグ
- 第1節または第2節の内容が異なるデータは連結できません。複数センター、複数参照時刻、複数格子系はマージできないということです。そんなことする奴はいないと思うけど。
あとは github issue みてください。
https://github.com/etoyoda/grib2png/issues?q=is%3Aopen+is%3Aissue+label%3Agribslim
