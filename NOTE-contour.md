# NOTE-contour.md - 等値線アルゴリズム

## Marching Squares アルゴリズム

https://en.wikipedia.org/wiki/Marching_squares

* 等値線を引くべきすべての値について、
* 与えられた二次元配列のすべてのセル（隣接する4点が囲む矩形）について、
* セルの4つの角をチェックして、等値面を超えているかを調べる
* このとき等号は不便（場合分けが増える）なので等値線の値より微小値大きいものとするアイデアがある (塩野ほか)
* 4つの真偽値を組み合わせると16通りの場合分けができる
* それぞれの場合についてセルの各辺と等値線の交点を（通常は線形補間により）求め、線分を描画する
* 二本の線が引かれるべき２通りについては、交差または二種類の鞍部が選べるが、4つの角の値の平均により鞍部の２種類を描き分けるアイデアがある

各セルについていきなり線を描画せず、
ひとつなぎの折線を構成する線分たちを集めてから描画する場合がある:

* 見栄えのためにスプラインなどの曲線を描く場合: これは補間でも対処できる (後述)
* PostScript など折線に適した中間データを用いる場合のファイル最小化
* 線分に等値線の値を書き加えるための把握 （割愛してもできなくはない）

折線の長さは予測困難であり、メモリ管理も面倒なので、選びたくない。

## 補間や間引き

データが多すぎる場合は、間引きをしたほうが、描画処理の高速化をしつつ、
画質は劣化させない、または多すぎる線によって読み取りが困難になるのを防ぐことができる。

データが少なすぎて描画が粗くなる場合、次の対処がありうる

* 折線を集めてからスプラインなどの曲線を描画する
* データを補間してから等値線描画ロジックにかける

データを補間したほうが心配が少ない。スプライン補間の挙動は保証が難しく、多数の等値線が集中するような場所では異なる値の等値線が交差してしまうことが発生しないとは保証できない。

気象庁の FAX 図用の FORTRAN ルーチンでは 301x301 格子の配列に間引きまたは補間している。
すなわち、302 格子以上であれば 1/2 に間引きし、603 格子以上であれば 1/3 に間引きし、 904 格子以上であれば 1/4 に間引きする。
いっぽうで 150 格子以下であれば 2 倍に引き伸ばして間を補間し、100 格子以下であれば 3 倍に引き伸ばして間を補間してゆく。
これにより等値線ロジックは 151..301 格子を入力とすることが保証される。

補間は線形であってはならない。周縁1セルを除いてはキュービック補間がよいだろう。


