# 天気図で用いるデータの検討
## 方針
* WIS GSM 1.25度格子データと、京大/支援センターMSM で動作したい
* bufrconv/run-plot.sh で普段ウォッチしているように、地上と500hPa高層はみたい
* 日本付近にズームインして明瞭な描像を
* いままで解析中心だったが予報もみたい

## 地上
プロットしたい要素は
* 風矢羽フィールド
* 海面更正気圧または相当品
* 下層相当温位による前線
* 雲型
* 降水域

風は 10m 高度風がある。迷うことはない。
900hPa風を観察してきたがあまり地上との対応がよくないので 10m のほうがマシだろう

海面更正気圧は素朴に存在するが、ズームインした際に冬場の大陸での荒れがいやだ。
下層（925-900hPa）あたりの等高線が望ましいのでは。
MSM であれば 975, 950, 925, 900 hPa が選べるが、
GSM であれば 925 hPa 一択となる。
面選択を許すのでなければ、 925 hPa となる。

前線算出のための下層相当温位のためには気温、湿度が必要。
上述の理屈で 925 hPa となる。

雲型は MSM であれば CLL/CLM/CLH/CLA が使える。
WIS GSM 1.25 度データには雲量がないので、 適当な層の湿度を
CLL/CLM と読み替えるのだろう。 CLH までそれでいいかは迷う。
出口はカテゴリ雲型にするつもりなので、
上層雲量の決定精度は悪くてもよいのかもしれない。
CLL代替は850hPaで疑いない。
CLM代替は700-500hPaが常識的レンジで、600hPa面のデータもMSM/GSMにあるが、既存天気図の慣例や、仮に安定度指数としてK-indexを使う可能性も考えると700hPaでいいのかなと思う。
CLH代替は300hPaなのだろう。
CLLがあるとき、なんらかの安定度指標で層積雲と積雲を区別しておきたい。
難しくしてもしょうがないので、
Total Totals index (TI) = T850+Td850-2T500 あたりが簡便だろうか。

降水域は時間ズレが問題。
WIS GSM 1.25 度データは 360 分毎。MSM は60分毎。
ひとつ厄介な問題は、時間をずらす方向。
気象庁の天気図では力学諸量の時刻「まで」の降水量を重畳するのが慣例だが、
これだと解析図に降水量が載せられない。
思い切って力学諸量の時刻「から」の降水量を重畳するほうがいいような気がする。

## 500hPa面
* 風
* 気温
* 高度

特に問題はない。欲をいうと

* 500hPaトラフ・リッジや300hPaジェット軸が抽出できるとよいのだが
* SSIなど安定度をみたほうがよいか
* 冬場の雪の診断に850hPa気温を見たがる人がいるが... いずれどうしてもなら。

## まとめ

* 下層雲量CLL
* 中層雲量CLM
* 上層雲量CLH
* 地上降水量（指定時刻からの）
* 10m 風(U,V)
* 925hPaジオポテンシャル
* 925hPa気温 (前線判定用)
* 925hPa湿度 (前線判定用)
* 850hPa気温 (TT算出用)
* 850hPa湿度 (TT算出・CLL代替用)
* 700hPa湿度 (CLM代替用)
* 500hPa気温 (TT算出・T500プロット用)
* 500hPaジオポテンシャル
* 300hPa湿度 (CLH代替用)

# 水平領域・解像度について

MSM データの得られる範囲は 22.4-47.6N, 120-150E である。
メルカトル投影すると南北31.3度相当、東西30度。
GSM 1.25 度データの場合は 22.5-47.5N, 120-150E でだいたい同じになる。
メルカトル投影すると南北31.0度相当、東西30度。

次はデータ解像度。
MSM 地上データは 505x481 格子 (0.05x0.0625度間隔)。
MSM 気圧面データは 253x241 格子 (0.1x0.125度間隔)。
GSM データは上記同等範囲で 21x25 格子。

これらを図化・ラスタライズする先は、
* JMH FAX 図であれば横幅 456 mm * 3.79 dot/mm = 1728 px 
* 上記 3.79 dot/mm は 96dpi に相当
* いっぽう G4 FAX は 200dpi であり、A4 用紙の短辺 210 mm = 1654 px, 長辺 297 mm = 2338 px に相当
といった調子である。
たとえば、A4 200 dpi の短辺に余裕を持って経度 30 度幅 (または緯度31.3度相当) を収められるように
するならば、 45 px/deg あたりにすることになろう。
古き良き GDPFS マニュアルに典拠を求め
緯度22.5度上縮尺2000万分の一に相当する 40.0 px/deg でもよいかもしれない。

等値線と記号プロットで扱いが分かれる。

風・雲形・降水は比較的粗い間隔で記号がプロットされる。
たとえば20px程度の間隔でプロットするならば、0.5 度格子となる。
GSM についてはデータそのまま、MSM については間引きが必要。

等値線についてはいくぶん細かい格子上でコンター生成することが考えられて、
たとえば5px程度の間隔でデータ点を置くならばそれは0.125度間隔で、
ちょうどMSM気圧面データの間隔となる。
GSM については粗すぎるので、できれば2-4倍密度の格子には補間すべきだろう。

# 予報時間について

GRIB2 からのデータ収集は、瞬間値の量については、
３要素（要素名、予報時間、鉛直面）の一致によればよい。
いっぽう瞬間値ではなく積算量たる降水量の場合、
予報時間 f と積算期間 d をチェックする必要があり、
さらに２データの差をとる場合がある。

GSM では f=0 で d が次第に大きくなる。
MSM では d=60 で f が次第に大きくなる。

## f=0 の探索

わりと簡単。差をとる必要もない。

* 1個レコードを保持できるポインタ変数を持っておく
* f=0 のレコードをみつけたら、ポインタを保持
* f=0 なるレコードを再度みつけたら、すでに保持したものよりdが小さいならばポインタを更新

## f>0 の探索

* 2個レコードを保持できるポインタ変数が必要。右辺と左辺と呼ぶ。
* 指定された f 値のレコードをみつけたら、左辺ポインタに格納。右辺ポインタはクリア。
* すべてのレコードについて、f+d を計算して、
 * * f+d が指定された f 値になっていれば、左辺ポインタに格納。
 * * f+d が指定された f 値よりも小さい場合、右辺ポインタに格納し、より大きいばあいは更新。
* 左辺と右辺があれば差をとる。左辺しかなければ差をとらないで使う。
